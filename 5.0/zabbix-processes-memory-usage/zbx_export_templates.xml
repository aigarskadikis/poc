<?xml version="1.0" encoding="UTF-8"?>
<zabbix_export>
    <version>5.0</version>
    <date>2022-02-03T00:13:51Z</date>
    <groups>
        <group>
            <name>Templates/Applications</name>
        </group>
    </groups>
    <templates>
        <template>
            <template>Zabbix processes memory usage</template>
            <name>Zabbix processes memory usage</name>
            <description>Install sudoers rule&#13;
===================&#13;
cd /etc/sudoers.d&#13;
echo 'zabbix ALL=(ALL) NOPASSWD: /usr/local/bin/ps_mem.py' | sudo tee zabbix_ps_mem&#13;
sudo chmod 0440 zabbix_ps_mem&#13;
&#13;
Distribute '/usr/local/bin/ps_mem.py' script to aggregate memory usage&#13;
===================&#13;
echo 'IyEvdXNyL2Jpbi9lbnYgcHl0aG9uCgojIFRyeSB0byBkZXRlcm1pbmUgaG93IG11Y2ggUkFNIGlzIGN1cnJlbnRseSBiZWluZyB1c2VkIHBlciBwcm9ncmFtLgojIE5vdGUgcGVyIF9wcm9ncmFtXywgbm90IHBlciBwcm9jZXNzLiBTbyBmb3IgZXhhbXBsZSB0aGlzIHNjcmlwdAojIHdpbGwgcmVwb3J0IFJBTSB1c2VkIGJ5IGFsbCBodHRwZCBwcm9jZXNzIHRvZ2V0aGVyLiBJbiBkZXRhaWwgaXQgcmVwb3J0czoKIyBzdW0ocHJpdmF0ZSBSQU0gZm9yIHByb2dyYW0gcHJvY2Vzc2VzKSArIHN1bShTaGFyZWQgUkFNIGZvciBwcm9ncmFtIHByb2Nlc3NlcykKIyBUaGUgc2hhcmVkIFJBTSBpcyBwcm9ibGVtYXRpYyB0byBjYWxjdWxhdGUsIGFuZCB0aGlzIHNjcmlwdCBhdXRvbWF0aWNhbGx5CiMgc2VsZWN0cyB0aGUgbW9zdCBhY2N1cmF0ZSBtZXRob2QgYXZhaWxhYmxlIGZvciB5b3VyIGtlcm5lbC4KCiMgTGljZW5jZTogTEdQTHYyCiMgQXV0aG9yOiAgUEBkcmFpZ0JyYWR5LmNvbQojIFNvdXJjZTogIGh0dHA6Ly93d3cucGl4ZWxiZWF0Lm9yZy9zY3JpcHRzL3BzX21lbS5weQoKIyBWMS4wICAgICAgMDYgSnVsIDIwMDUgICAgIEluaXRpYWwgcmVsZWFzZQojIFYxLjEgICAgICAxMSBBdWcgMjAwNiAgICAgcm9vdCBwZXJtaXNzaW9uIHJlcXVpcmVkIGZvciBhY2N1cmFjeQojIFYxLjIgICAgICAwOCBOb3YgMjAwNiAgICAgQWRkIHRvdGFsIHRvIG91dHB1dAojICAgICAgICAgICAgICAgICAgICAgICAgICAgVXNlIEtpQixNaUIsLi4uIGZvciB1bml0cyByYXRoZXIgdGhhbiBLLE0sLi4uCiMgVjEuMyAgICAgIDIyIE5vdiAyMDA2ICAgICBJZ25vcmUgc2hhcmVkIGNvbCBmcm9tIC9wcm9jLyRwaWQvc3RhdG0gZm9yCiMgICAgICAgICAgICAgICAgICAgICAgICAgICAyLjYga2VybmVscyB1cCB0byBhbmQgaW5jbHVkaW5nIDIuNi45LgojICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlcmUgaXQgcmVwcmVzZW50ZWQgdGhlIHRvdGFsIGZpbGUgYmFja2VkIGV4dGVudAojIFYxLjQgICAgICAyMyBOb3YgMjAwNiAgICAgUmVtb3ZlIHRvdGFsIGZyb20gb3V0cHV0IGFzIGl0J3MgbWVhbmluZ2xlc3MKIyAgICAgICAgICAgICAgICAgICAgICAgICAgICh0aGUgc2hhcmVkIHZhbHVlcyBvdmVybGFwIHdpdGggb3RoZXIgcHJvZ3JhbXMpLgojICAgICAgICAgICAgICAgICAgICAgICAgICAgRGlzcGxheSB0aGUgc2hhcmVkIGNvbHVtbi4gVGhpcyBleHRyYSBpbmZvIGlzCiMgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VmdWwsIGVzcGVjaWFsbHkgYXMgaXQgb3ZlcmxhcHMgYmV0d2VlbiBwcm9ncmFtcy4KIyBWMS41ICAgICAgMjYgTWFyIDIwMDcgICAgIFJlbW92ZSByZWR1bmRhbnQgcmVjdXJzaW9uIGZyb20gaHVtYW4oKQojIFYxLjYgICAgICAwNSBKdW4gMjAwNyAgICAgQWxzbyByZXBvcnQgbnVtYmVyIG9mIHByb2Nlc3NlcyB3aXRoIGEgZ2l2ZW4gbmFtZS4KIyAgICAgICAgICAgICAgICAgICAgICAgICAgIFBhdGNoIGZyb20gcmljY2FyZG8ubXVycmlAZ21haWwuY29tCiMgVjEuNyAgICAgIDIwIFNlcCAyMDA3ICAgICBVc2UgUFNTIGZyb20gL3Byb2MvJHBpZC9zbWFwcyBpZiBhdmFpbGFibGUsIHdoaWNoCiMgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXhlcyBzb21lIG92ZXItZXN0aW1hdGlvbiBhbmQgYWxsb3dzIHRvdGFsbGluZy4KIyAgICAgICAgICAgICAgICAgICAgICAgICAgIEVudW1lcmF0ZSB0aGUgUElEcyBkaXJlY3RseSByYXRoZXIgdGhhbiB1c2luZyBwcywKIyAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWNoIGZpeGVzIHRoZSBwb3NzaWJsZSByYWNlIGJldHdlZW4gcmVhZGluZwojICAgICAgICAgICAgICAgICAgICAgICAgICAgUlNTIHdpdGggcHMsIGFuZCBzaGFyZWQgbWVtb3J5IHdpdGggdGhpcyBwcm9ncmFtLgojICAgICAgICAgICAgICAgICAgICAgICAgICAgQWxzbyB3ZSBjYW4gc2hvdyBub24gdHJ1bmNhdGVkIGNvbW1hbmQgbmFtZXMuCiMgVjEuOCAgICAgIDI4IFNlcCAyMDA3ICAgICBNb3JlIGFjY3VyYXRlIG1hdGNoaW5nIGZvciBzdGF0cyBpbiAvcHJvYy8kcGlkL3NtYXBzCiMgICAgICAgICAgICAgICAgICAgICAgICAgICBhcyBvdGhlcndpc2UgY291bGQgbWF0Y2ggbGlicmFyaWVzIGNhdXNpbmcgYSBjcmFzaC4KIyAgICAgICAgICAgICAgICAgICAgICAgICAgIFBhdGNoIGZyb20gcGF0cmljZS5ib3VjaGFuZC5mZWRvcmFAZ21haWwuY29tCiMgVjEuOSAgICAgIDIwIEZlYiAyMDA4ICAgICBGaXggaW52YWxpZCB2YWx1ZXMgcmVwb3J0ZWQgd2hlbiBQU1MgaXMgYXZhaWxhYmxlLgojICAgICAgICAgICAgICAgICAgICAgICAgICAgUmVwb3J0ZWQgYnkgQW5kcmV5IEJvcnplbmtvdiA8YXJ2aWRqYWFyQG1haWwucnU+CiMgVjMuNSAgICAgIDI5IFNlcCAyMDE1CiMgICBodHRwOi8vZ2l0aHViLmNvbS9waXhlbGIvc2NyaXB0cy9jb21taXRzL21hc3Rlci9zY3JpcHRzL3BzX21lbS5weQoKIyBOb3RlczoKIwojIEFsbCBpbnRlcnByZXRlZCBwcm9ncmFtcyB3aGVyZSB0aGUgaW50ZXJwcmV0ZXIgaXMgc3RhcnRlZAojIGJ5IHRoZSBzaGVsbCBvciB3aXRoIGVudiwgd2lsbCBiZSBtZXJnZWQgdG8gdGhlIGludGVycHJldGVyCiMgKGFzIHRoYXQncyB3aGF0J3MgZ2l2ZW4gdG8gZXhlYykuIEZvciBlLmcuIGFsbCBweXRob24gcHJvZ3JhbXMKIyBzdGFydGluZyB3aXRoICIjIS91c3IvYmluL2VudiBweXRob24iIHdpbGwgYmUgZ3JvdXBlZCB1bmRlciBweXRob24uCiMgWW91IGNhbiBjaGFuZ2UgdGhpcyBieSB1c2luZyB0aGUgZnVsbCBjb21tYW5kIGxpbmUgYnV0IHRoYXQgd2lsbAojIGhhdmUgdGhlIHVuZGVzaXJhYmxlIGFmZmVjdCBvZiBzcGxpdHRpbmcgdXAgcHJvZ3JhbXMgc3RhcnRlZCB3aXRoCiMgZGlmZmVyaW5nIHBhcmFtZXRlcnMgKGZvciBlLmcuIG1pbmdldHR5IHR0eVsxLTZdKS4KIwojIEZvciAyLjYga2VybmVscyB1cCB0byBhbmQgaW5jbHVkaW5nIDIuNi4xMyBhbmQgbGF0ZXIgMi40IHJlZGhhdCBrZXJuZWxzCiMgKHJtYXAgdm0gd2l0aG91dCBzbWFwcykgaXQgY2FuIG5vdCBiZSBhY2N1cmF0ZWx5IGRldGVybWluZWQgaG93IG1hbnkgcGFnZXMKIyBhcmUgc2hhcmVkIGJldHdlZW4gcHJvY2Vzc2VzIGluIGdlbmVyYWwgb3Igd2l0aGluIGEgcHJvZ3JhbSBpbiBvdXIgY2FzZToKIyBodHRwOi8vbGttbC5vcmcvbGttbC8yMDA1LzcvNi8yNTAKIyBBIHdhcm5pbmcgaXMgcHJpbnRlZCBpZiBvdmVyZXN0aW1hdGlvbiBpcyBwb3NzaWJsZS4KIyBJbiBhZGRpdGlvbiBmb3IgMi42IGtlcm5lbHMgdXAgdG8gMi42LjkgaW5jbHVzaXZlLCB0aGUgc2hhcmVkCiMgdmFsdWUgaW4gL3Byb2MvJHBpZC9zdGF0bSBpcyB0aGUgdG90YWwgZmlsZS1iYWNrZWQgZXh0ZW50IG9mIGEgcHJvY2Vzcy4KIyBXZSBpZ25vcmUgdGhhdCwgaW50cm9kdWNpbmcgbW9yZSBvdmVyZXN0aW1hdGlvbiwgYWdhaW4gcHJpbnRpbmcgYSB3YXJuaW5nLgojIFNpbmNlIGtlcm5lbCAyLjYuMjMtcmM4LW1tMSBQU1MgaXMgYXZhaWxhYmxlIGluIHNtYXBzLCB3aGljaCBhbGxvd3MKIyB1cyB0byBjYWxjdWxhdGUgYSBtb3JlIGFjY3VyYXRlIHZhbHVlIGZvciB0aGUgdG90YWwgUkFNIHVzZWQgYnkgcHJvZ3JhbXMuCiMKIyBQcm9ncmFtcyB0aGF0IHVzZSBDTE9ORV9WTSB3aXRob3V0IENMT05FX1RIUkVBRCBhcmUgZGlzY291bnRlZCBieSBhc3N1bWluZwojIHRoZXkncmUgdGhlIG9ubHkgcHJvZ3JhbXMgdGhhdCBoYXZlIHRoZSBzYW1lIC9wcm9jLyRQSUQvc21hcHMgZmlsZSBmb3IKIyBlYWNoIGluc3RhbmNlLiAgVGhpcyB3aWxsIGZhaWwgaWYgdGhlcmUgYXJlIG11bHRpcGxlIHJlYWwgaW5zdGFuY2VzIG9mIGEKIyBwcm9ncmFtIHRoYXQgdGhlbiB1c2UgQ0xPTkVfVk0gd2l0aG91dCBDTE9ORV9USFJFQUQsIG9yIGlmIGEgY2xvbmUgY2hhbmdlcwojIGl0cyBtZW1vcnkgbWFwIHdoaWxlIHdlJ3JlIGNoZWNrc3VtbWluZyBlYWNoIC9wcm9jLyRQSUQvc21hcHMuCiMKIyBJIGRvbid0IHRha2UgYWNjb3VudCBvZiBtZW1vcnkgYWxsb2NhdGVkIGZvciBhIHByb2dyYW0KIyBieSBvdGhlciBwcm9ncmFtcy4gRm9yIGUuZy4gbWVtb3J5IHVzZWQgaW4gdGhlIFggc2VydmVyIGZvcgojIGEgcHJvZ3JhbSBjb3VsZCBiZSBkZXRlcm1pbmVkLCBidXQgaXMgbm90LgojCiMgRnJlZUJTRCBpcyBzdXBwb3J0ZWQgaWYgbGlucHJvY2ZzIGlzIG1vdW50ZWQgYXQgL2NvbXBhdC9saW51eC9wcm9jLwojIEZyZWVCU0QgOC4wIHN1cHBvcnRzIHVwIHRvIGEgbGV2ZWwgb2YgTGludXggMi42LjE2CgppbXBvcnQgZ2V0b3B0CmltcG9ydCB0aW1lCmltcG9ydCBlcnJubwppbXBvcnQgb3MKaW1wb3J0IHN5cwoKIyBUaGUgZm9sbG93aW5nIGV4aXRzIGNsZWFubHkgb24gQ3RybC1DIG9yIEVQSVBFCiMgd2hpbGUgdHJlYXRpbmcgb3RoZXIgZXhjZXB0aW9ucyBhcyBiZWZvcmUuCmRlZiBzdGRfZXhjZXB0aW9ucyhldHlwZSwgdmFsdWUsIHRiKToKICAgIHN5cy5leGNlcHRob29rID0gc3lzLl9fZXhjZXB0aG9va19fCiAgICBpZiBpc3N1YmNsYXNzKGV0eXBlLCBLZXlib2FyZEludGVycnVwdCk6CiAgICAgICAgcGFzcwogICAgZWxpZiBpc3N1YmNsYXNzKGV0eXBlLCBJT0Vycm9yKSBhbmQgdmFsdWUuZXJybm8gPT0gZXJybm8uRVBJUEU6CiAgICAgICAgcGFzcwogICAgZWxzZToKICAgICAgICBzeXMuX19leGNlcHRob29rX18oZXR5cGUsIHZhbHVlLCB0YikKc3lzLmV4Y2VwdGhvb2sgPSBzdGRfZXhjZXB0aW9ucwoKIwojICAgRGVmaW5lIHNvbWUgZ2xvYmFsIHZhcmlhYmxlcwojCgpQQUdFU0laRSA9IG9zLnN5c2NvbmYoIlNDX1BBR0VfU0laRSIpIC8gMTAyNCAjS2lCCm91cl9waWQgPSBvcy5nZXRwaWQoKQoKaGF2ZV9wc3MgPSAwCgpjbGFzcyBQcm9jOgogICAgZGVmIF9faW5pdF9fKHNlbGYpOgogICAgICAgIHVuYW1lID0gb3MudW5hbWUoKQogICAgICAgIGlmIHVuYW1lWzBdID09ICJGcmVlQlNEIjoKICAgICAgICAgICAgc2VsZi5wcm9jID0gJy9jb21wYXQvbGludXgvcHJvYycKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLnByb2MgPSAnL3Byb2MnCgogICAgZGVmIHBhdGgoc2VsZiwgKmFyZ3MpOgogICAgICAgIHJldHVybiBvcy5wYXRoLmpvaW4oc2VsZi5wcm9jLCAqKHN0cihhKSBmb3IgYSBpbiBhcmdzKSkKCiAgICBkZWYgb3BlbihzZWxmLCAqYXJncyk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBzeXMudmVyc2lvbl9pbmZvIDwgKDMsKToKICAgICAgICAgICAgICAgIHJldHVybiBvcGVuKHNlbGYucGF0aCgqYXJncykpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICByZXR1cm4gb3BlbihzZWxmLnBhdGgoKmFyZ3MpLCBlcnJvcnM9J2lnbm9yZScpCiAgICAgICAgZXhjZXB0IChJT0Vycm9yLCBPU0Vycm9yKToKICAgICAgICAgICAgdmFsID0gc3lzLmV4Y19pbmZvKClbMV0KICAgICAgICAgICAgaWYgKHZhbC5lcnJubyA9PSBlcnJuby5FTk9FTlQgb3IgIyBrZXJuZWwgdGhyZWFkIG9yIHByb2Nlc3MgZ29uZQogICAgICAgICAgICAgICAgdmFsLmVycm5vID09IGVycm5vLkVQRVJNKToKICAgICAgICAgICAgICAgIHJhaXNlIExvb2t1cEVycm9yCiAgICAgICAgICAgIHJhaXNlCgpwcm9jID0gUHJvYygpCgoKIwojICAgRnVuY3Rpb25zCiMKCmRlZiBwYXJzZV9vcHRpb25zKCk6CiAgICB0cnk6CiAgICAgICAgbG9uZ19vcHRpb25zID0gWydzcGxpdC1hcmdzJywgJ2hlbHAnLCAndG90YWwnXQogICAgICAgIG9wdHMsIGFyZ3MgPSBnZXRvcHQuZ2V0b3B0KHN5cy5hcmd2WzE6XSwgInNodHA6dzoiLCBsb25nX29wdGlvbnMpCiAgICBleGNlcHQgZ2V0b3B0LkdldG9wdEVycm9yOgogICAgICAgIHN5cy5zdGRlcnIud3JpdGUoaGVscCgpKQogICAgICAgIHN5cy5leGl0KDMpCgogICAgaWYgbGVuKGFyZ3MpOgogICAgICAgIHN5cy5zdGRlcnIud3JpdGUoIkV4dHJhbmVvdXMgYXJndW1lbnRzOiAlc1xuIiAlIGFyZ3MpCiAgICAgICAgc3lzLmV4aXQoMykKCiAgICAjIHBzX21lbS5weSBvcHRpb25zCiAgICBzcGxpdF9hcmdzID0gRmFsc2UKICAgIHBpZHNfdG9fc2hvdyA9IE5vbmUKICAgIHdhdGNoID0gTm9uZQogICAgb25seV90b3RhbCA9IEZhbHNlCgogICAgZm9yIG8sIGEgaW4gb3B0czoKICAgICAgICBpZiBvIGluICgnLXMnLCAnLS1zcGxpdC1hcmdzJyk6CiAgICAgICAgICAgIHNwbGl0X2FyZ3MgPSBUcnVlCiAgICAgICAgaWYgbyBpbiAoJy10JywgJy0tdG90YWwnKToKICAgICAgICAgICAgb25seV90b3RhbCA9IFRydWUKICAgICAgICBpZiBvIGluICgnLWgnLCAnLS1oZWxwJyk6CiAgICAgICAgICAgIHN5cy5zdGRvdXQud3JpdGUoaGVscCgpKQogICAgICAgICAgICBzeXMuZXhpdCgwKQogICAgICAgIGlmIG8gaW4gKCctcCcsKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcGlkc190b19zaG93ID0gW2ludCh4KSBmb3IgeCBpbiBhLnNwbGl0KCcsJyldCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHN5cy5zdGRlcnIud3JpdGUoaGVscCgpKQogICAgICAgICAgICAgICAgc3lzLmV4aXQoMykKICAgICAgICBpZiBvIGluICgnLXcnLCk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHdhdGNoID0gaW50KGEpCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHN5cy5zdGRlcnIud3JpdGUoaGVscCgpKQogICAgICAgICAgICAgICAgc3lzLmV4aXQoMykKCiAgICByZXR1cm4gKHNwbGl0X2FyZ3MsIHBpZHNfdG9fc2hvdywgd2F0Y2gsIG9ubHlfdG90YWwpCgpkZWYgaGVscCgpOgogICAgaGVscF9tc2cgPSAnVXNhZ2U6IHBzX21lbSBbT1BUSU9OXS4uLlxuJyBcCiAgICAnU2hvdyBwcm9ncmFtIGNvcmUgbWVtb3J5IHVzYWdlXG4nIFwKICAgICdcbicgXAogICAgJyAgLWgsIC1oZWxwICAgICAgICAgICAgICAgICAgIFNob3cgdGhpcyBoZWxwXG4nIFwKICAgICcgIC1wIDxwaWQ+WyxwaWQyLC4uLnBpZE5dICAgICBPbmx5IHNob3cgbWVtb3J5IHVzYWdlIFBJRHMgaW4gdGhlIHNwZWNpZmllZCBsaXN0XG4nIFwKICAgICcgIC1zLCAtLXNwbGl0LWFyZ3MgICAgICAgICAgICBTaG93IGFuZCBzZXBhcmF0ZSBieSwgYWxsIGNvbW1hbmQgbGluZSBhcmd1bWVudHNcbicgXAogICAgJyAgLXQsIC0tdG90YWwgICAgICAgICAgICAgICAgIFNob3cgb25seSB0aGUgdG90YWwgdmFsdWVcbicgXAogICAgJyAgLXcgPE4+ICAgICAgICAgICAgICAgICAgICAgIE1lYXN1cmUgYW5kIHNob3cgcHJvY2VzcyBtZW1vcnkgZXZlcnkgTiBzZWNvbmRzXG4nCgogICAgcmV0dXJuIGhlbHBfbXNnCgojKG1ham9yLG1pbm9yLHJlbGVhc2UpCmRlZiBrZXJuZWxfdmVyKCk6CiAgICBrdiA9IHByb2Mub3Blbignc3lzL2tlcm5lbC9vc3JlbGVhc2UnKS5yZWFkbGluZSgpLnNwbGl0KCIuIilbOjNdCiAgICBsYXN0ID0gbGVuKGt2KQogICAgaWYgbGFzdCA9PSAyOgogICAgICAgIGt2LmFwcGVuZCgnMCcpCiAgICBsYXN0IC09IDEKICAgIHdoaWxlIGxhc3QgPiAwOgogICAgICAgIGZvciBjaGFyIGluICItXyI6CiAgICAgICAgICAgIGt2W2xhc3RdID0ga3ZbbGFzdF0uc3BsaXQoY2hhcilbMF0KICAgICAgICB0cnk6CiAgICAgICAgICAgIGludChrdltsYXN0XSkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIGt2W2xhc3RdID0gMAogICAgICAgIGxhc3QgLT0gMQogICAgcmV0dXJuIChpbnQoa3ZbMF0pLCBpbnQoa3ZbMV0pLCBpbnQoa3ZbMl0pKQoKCiNyZXR1cm4gUHJpdmF0ZSxTaGFyZWQKI05vdGUgc2hhcmVkIGlzIGFsd2F5cyBhIHN1YnNldCBvZiByc3MgKHRycyBpcyBub3QgYWx3YXlzKQpkZWYgZ2V0TWVtU3RhdHMocGlkKToKICAgIGdsb2JhbCBoYXZlX3BzcwogICAgbWVtX2lkID0gcGlkICN1bmlxdWUKICAgIFByaXZhdGVfbGluZXMgPSBbXQogICAgU2hhcmVkX2xpbmVzID0gW10KICAgIFBzc19saW5lcyA9IFtdCiAgICBSc3MgPSAoaW50KHByb2Mub3BlbihwaWQsICdzdGF0bScpLnJlYWRsaW5lKCkuc3BsaXQoKVsxXSkKICAgICAgICAgICAqIFBBR0VTSVpFKQogICAgaWYgb3MucGF0aC5leGlzdHMocHJvYy5wYXRoKHBpZCwgJ3NtYXBzJykpOiAjc3RhdAogICAgICAgIGxpbmVzID0gcHJvYy5vcGVuKHBpZCwgJ3NtYXBzJykucmVhZGxpbmVzKCkgI29wZW4KICAgICAgICAjIE5vdGUgd2UgY2hlY2tzdW0gc21hcHMgYXMgbWFwcyBpcyB1c3VhbGx5IGJ1dAogICAgICAgICMgbm90IGFsd2F5cyBkaWZmZXJlbnQgZm9yIHNlcGFyYXRlIHByb2Nlc3Nlcy4KICAgICAgICBtZW1faWQgPSBoYXNoKCcnLmpvaW4obGluZXMpKQogICAgICAgIGZvciBsaW5lIGluIGxpbmVzOgogICAgICAgICAgICBpZiBsaW5lLnN0YXJ0c3dpdGgoIlNoYXJlZCIpOgogICAgICAgICAgICAgICAgU2hhcmVkX2xpbmVzLmFwcGVuZChsaW5lKQogICAgICAgICAgICBlbGlmIGxpbmUuc3RhcnRzd2l0aCgiUHJpdmF0ZSIpOgogICAgICAgICAgICAgICAgUHJpdmF0ZV9saW5lcy5hcHBlbmQobGluZSkKICAgICAgICAgICAgZWxpZiBsaW5lLnN0YXJ0c3dpdGgoIlBzcyIpOgogICAgICAgICAgICAgICAgaGF2ZV9wc3MgPSAxCiAgICAgICAgICAgICAgICBQc3NfbGluZXMuYXBwZW5kKGxpbmUpCiAgICAgICAgU2hhcmVkID0gc3VtKFtpbnQobGluZS5zcGxpdCgpWzFdKSBmb3IgbGluZSBpbiBTaGFyZWRfbGluZXNdKQogICAgICAgIFByaXZhdGUgPSBzdW0oW2ludChsaW5lLnNwbGl0KClbMV0pIGZvciBsaW5lIGluIFByaXZhdGVfbGluZXNdKQogICAgICAgICNOb3RlIFNoYXJlZCArIFByaXZhdGUgPSBSc3MgYWJvdmUKICAgICAgICAjVGhlIFJzcyBpbiBzbWFwcyBpbmNsdWRlcyB2aWRlbyBjYXJkIG1lbSBldGMuCiAgICAgICAgaWYgaGF2ZV9wc3M6CiAgICAgICAgICAgIHBzc19hZGp1c3QgPSAwLjUgIyBhZGQgMC41S2lCIGFzIHRoaXMgYXZnIGVycm9yIGR1ZSB0byB0cnVuY3RhdGlvbgogICAgICAgICAgICBQc3MgPSBzdW0oW2Zsb2F0KGxpbmUuc3BsaXQoKVsxXSkrcHNzX2FkanVzdCBmb3IgbGluZSBpbiBQc3NfbGluZXNdKQogICAgICAgICAgICBTaGFyZWQgPSBQc3MgLSBQcml2YXRlCiAgICBlbGlmICgyLDYsMSkgPD0ga2VybmVsX3ZlcigpIDw9ICgyLDYsOSk6CiAgICAgICAgU2hhcmVkID0gMCAjbG90cyBvZiBvdmVyZXN0aW1hdGlvbiwgYnV0IHdoYXQgY2FuIHdlIGRvPwogICAgICAgIFByaXZhdGUgPSBSc3MKICAgIGVsc2U6CiAgICAgICAgU2hhcmVkID0gaW50KHByb2Mub3BlbihwaWQsICdzdGF0bScpLnJlYWRsaW5lKCkuc3BsaXQoKVsyXSkKICAgICAgICBTaGFyZWQgKj0gUEFHRVNJWkUKICAgICAgICBQcml2YXRlID0gUnNzIC0gU2hhcmVkCiAgICByZXR1cm4gKFByaXZhdGUsIFNoYXJlZCwgbWVtX2lkKQoKCmRlZiBnZXRDbWROYW1lKHBpZCwgc3BsaXRfYXJncyk6CiAgICBjbWRsaW5lID0gcHJvYy5vcGVuKHBpZCwgJ2NtZGxpbmUnKS5yZWFkKCkuc3BsaXQoIlwwIikKICAgIGlmIGNtZGxpbmVbLTFdID09ICcnIGFuZCBsZW4oY21kbGluZSkgPiAxOgogICAgICAgIGNtZGxpbmUgPSBjbWRsaW5lWzotMV0KCiAgICBwYXRoID0gcHJvYy5wYXRoKHBpZCwgJ2V4ZScpCiAgICB0cnk6CiAgICAgICAgcGF0aCA9IG9zLnJlYWRsaW5rKHBhdGgpCiAgICAgICAgIyBTb21lIHN5bWxpbmsgdGFyZ2V0cyB3ZXJlIHNlZW4gdG8gY29udGFpbiBOVUxzIG9uIFJIRUwgNSBhdCBsZWFzdAogICAgICAgICMgaHR0cHM6Ly9naXRodWIuY29tL3BpeGVsYi9zY3JpcHRzL3B1bGwvMTAsIHNvIHRha2Ugc3RyaW5nIHVwIHRvIE5VTAogICAgICAgIHBhdGggPSBwYXRoLnNwbGl0KCdcMCcpWzBdCiAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICB2YWwgPSBzeXMuZXhjX2luZm8oKVsxXQogICAgICAgIGlmICh2YWwuZXJybm8gPT0gZXJybm8uRU5PRU5UIG9yICMgZWl0aGVyIGtlcm5lbCB0aHJlYWQgb3IgcHJvY2VzcyBnb25lCiAgICAgICAgICAgIHZhbC5lcnJubyA9PSBlcnJuby5FUEVSTSk6CiAgICAgICAgICAgIHJhaXNlIExvb2t1cEVycm9yCiAgICAgICAgcmFpc2UKCiAgICBpZiBzcGxpdF9hcmdzOgogICAgICAgIHJldHVybiAiICIuam9pbihjbWRsaW5lKQogICAgaWYgcGF0aC5lbmRzd2l0aCgiIChkZWxldGVkKSIpOgogICAgICAgIHBhdGggPSBwYXRoWzotMTBdCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMocGF0aCk6CiAgICAgICAgICAgIHBhdGggKz0gIiBbdXBkYXRlZF0iCiAgICAgICAgZWxzZToKICAgICAgICAgICAgI1RoZSBwYXRoIGNvdWxkIGJlIGhhdmUgcHJlbGluayBzdHVmZiBzbyB0cnkgY21kbGluZQogICAgICAgICAgICAjd2hpY2ggbWlnaHQgaGF2ZSB0aGUgZnVsbCBwYXRoIHByZXNlbnQuIFRoaXMgaGVscGVkIGZvcjoKICAgICAgICAgICAgIy91c3IvbGliZXhlYy9ub3RpZmljYXRpb24tYXJlYS1hcHBsZXQuI3ByZWxpbmsjLmZYN0xDVCAoZGVsZXRlZCkKICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoY21kbGluZVswXSk6CiAgICAgICAgICAgICAgICBwYXRoID0gY21kbGluZVswXSArICIgW3VwZGF0ZWRdIgogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcGF0aCArPSAiIFtkZWxldGVkXSIKICAgIGV4ZSA9IG9zLnBhdGguYmFzZW5hbWUocGF0aCkKICAgIGNtZCA9IHByb2Mub3BlbihwaWQsICdzdGF0dXMnKS5yZWFkbGluZSgpWzY6LTFdCiAgICBpZiBleGUuc3RhcnRzd2l0aChjbWQpOgogICAgICAgIGNtZCA9IGV4ZSAjc2hvdyBub24gdHJ1bmNhdGVkIHZlcnNpb24KICAgICAgICAjTm90ZSBiZWNhdXNlIHdlIHNob3cgdGhlIG5vbiB0cnVuY2F0ZWQgbmFtZQogICAgICAgICNvbmUgY2FuIGhhdmUgc2VwYXJhdGVkIHByb2dyYW1zIGFzIGZvbGxvd3M6CiAgICAgICAgIzU4NC4wIEtpQiArICAgMS4wIE1pQiA9ICAgMS42IE1pQiAgICBtb3ppbGxhLXRodW5kZXIgKGV4ZSAtPiBiYXNoKQogICAgICAgICMgNTYuMCBNaUIgKyAgMjIuMiBNaUIgPSAgNzguMiBNaUIgICAgbW96aWxsYS10aHVuZGVyYmlyZC1iaW4KICAgIGlmIHN5cy52ZXJzaW9uX2luZm8gPCAoMywpOgogICAgICAgIHJldHVybiBjbWQKICAgIGVsc2U6CiAgICAgICAgcmV0dXJuIGNtZC5lbmNvZGUoZXJyb3JzPSdyZXBsYWNlJykuZGVjb2RlKCkKCgojVGhlIGZvbGxvd2luZyBtYXRjaGVzICJkdSAtaCIgb3V0cHV0CiNzZWUgYWxzbyBodW1hbi5weQpkZWYgaHVtYW4obnVtLCBwb3dlcj0iS2kiLCB1bml0cz1Ob25lKToKICAgIGlmIHVuaXRzIGlzIE5vbmU6CiAgICAgICAgcG93ZXJzID0gWyJLaSIsICJNaSIsICJHaSIsICJUaSJdCiAgICAgICAgd2hpbGUgbnVtID49IDEwMDA6ICM0IGRpZ2l0cwogICAgICAgICAgICBudW0gLz0gMTAyNC4wCiAgICAgICAgICAgIHBvd2VyID0gcG93ZXJzW3Bvd2Vycy5pbmRleChwb3dlcikrMV0KICAgICAgICByZXR1cm4gIiUuMWYgJXNCIiAlIChudW0sIHBvd2VyKQogICAgZWxzZToKICAgICAgICByZXR1cm4gIiUuZiIgJSAoKG51bSAqIDEwMjQpIC8gdW5pdHMpCgoKZGVmIGNtZF93aXRoX2NvdW50KGNtZCwgY291bnQpOgogICAgaWYgY291bnQgPiAxOgogICAgICAgIHJldHVybiAiJXMgKCV1KSIgJSAoY21kLCBjb3VudCkKICAgIGVsc2U6CiAgICAgICAgcmV0dXJuIGNtZAoKI1dhcm4gb2YgcG9zc2libGUgaW5hY2N1cmFjaWVzCiMyID0gYWNjdXJhdGUgJiBjYW4gdG90YWwKIzEgPSBhY2N1cmF0ZSBvbmx5IGNvbnNpZGVyaW5nIGVhY2ggcHJvY2VzcyBpbiBpc29sYXRpb24KIzAgPSBzb21lIHNoYXJlZCBtZW0gbm90IHJlcG9ydGVkCiMtMT0gYWxsIHNoYXJlZCBtZW0gbm90IHJlcG9ydGVkCmRlZiBzaGFyZWRfdmFsX2FjY3VyYWN5KCk6CiAgICAiIiJodHRwOi8vd2lraS5hcGFjaGUub3JnL3NwYW1hc3Nhc3Npbi9Ub3BTaGFyZWRNZW1vcnlCdWciIiIKICAgIGt2ID0ga2VybmVsX3ZlcigpCiAgICBwaWQgPSBvcy5nZXRwaWQoKQogICAgaWYga3ZbOjJdID09ICgyLDQpOgogICAgICAgIGlmIHByb2Mub3BlbignbWVtaW5mbycpLnJlYWQoKS5maW5kKCJJbmFjdF8iKSA9PSAtMToKICAgICAgICAgICAgcmV0dXJuIDEKICAgICAgICByZXR1cm4gMAogICAgZWxpZiBrdls6Ml0gPT0gKDIsNik6CiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMocHJvYy5wYXRoKHBpZCwgJ3NtYXBzJykpOgogICAgICAgICAgICBpZiBwcm9jLm9wZW4ocGlkLCAnc21hcHMnKS5yZWFkKCkuZmluZCgiUHNzOiIpIT0tMToKICAgICAgICAgICAgICAgIHJldHVybiAyCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICByZXR1cm4gMQogICAgICAgIGlmICgyLDYsMSkgPD0ga3YgPD0gKDIsNiw5KToKICAgICAgICAgICAgcmV0dXJuIC0xCiAgICAgICAgcmV0dXJuIDAKICAgIGVsaWYga3ZbMF0gPiAyIGFuZCBvcy5wYXRoLmV4aXN0cyhwcm9jLnBhdGgocGlkLCAnc21hcHMnKSk6CiAgICAgICAgcmV0dXJuIDIKICAgIGVsc2U6CiAgICAgICAgcmV0dXJuIDEKCmRlZiBzaG93X3NoYXJlZF92YWxfYWNjdXJhY3koIHBvc3NpYmxlX2luYWNjLCBvbmx5X3RvdGFsPUZhbHNlICk6CiAgICBsZXZlbCA9ICgiV2FybmluZyIsIkVycm9yIilbb25seV90b3RhbF0KICAgIGlmIHBvc3NpYmxlX2luYWNjID09IC0xOgogICAgICAgIHN5cy5zdGRlcnIud3JpdGUoCiAgICAgICAgICIlczogU2hhcmVkIG1lbW9yeSBpcyBub3QgcmVwb3J0ZWQgYnkgdGhpcyBzeXN0ZW0uXG4iICUgbGV2ZWwKICAgICAgICApCiAgICAgICAgc3lzLnN0ZGVyci53cml0ZSgKICAgICAgICAgIlZhbHVlcyByZXBvcnRlZCB3aWxsIGJlIHRvbyBsYXJnZSwgYW5kIHRvdGFscyBhcmUgbm90IHJlcG9ydGVkXG4iCiAgICAgICAgKQogICAgZWxpZiBwb3NzaWJsZV9pbmFjYyA9PSAwOgogICAgICAgIHN5cy5zdGRlcnIud3JpdGUoCiAgICAgICAgICIlczogU2hhcmVkIG1lbW9yeSBpcyBub3QgcmVwb3J0ZWQgYWNjdXJhdGVseSBieSB0aGlzIHN5c3RlbS5cbiIgJSBsZXZlbAogICAgICAgICkKICAgICAgICBzeXMuc3RkZXJyLndyaXRlKAogICAgICAgICAiVmFsdWVzIHJlcG9ydGVkIGNvdWxkIGJlIHRvbyBsYXJnZSwgYW5kIHRvdGFscyBhcmUgbm90IHJlcG9ydGVkXG4iCiAgICAgICAgKQogICAgZWxpZiBwb3NzaWJsZV9pbmFjYyA9PSAxOgogICAgICAgIHN5cy5zdGRlcnIud3JpdGUoCiAgICAgICAgICIlczogU2hhcmVkIG1lbW9yeSBpcyBzbGlnaHRseSBvdmVyLWVzdGltYXRlZCBieSB0aGlzIHN5c3RlbVxuIgogICAgICAgICAiZm9yIGVhY2ggcHJvZ3JhbSwgc28gdG90YWxzIGFyZSBub3QgcmVwb3J0ZWQuXG4iICUgbGV2ZWwKICAgICAgICApCiAgICBzeXMuc3RkZXJyLmNsb3NlKCkKICAgIGlmIG9ubHlfdG90YWwgYW5kIHBvc3NpYmxlX2luYWNjICE9IDI6CiAgICAgICAgc3lzLmV4aXQoMSkKCmRlZiBnZXRfbWVtb3J5X3VzYWdlKCBwaWRzX3RvX3Nob3csIHNwbGl0X2FyZ3MsIGluY2x1ZGVfc2VsZj1GYWxzZSwgb25seV9zZWxmPUZhbHNlICk6CiAgICBjbWRzID0ge30KICAgIHNoYXJlZHMgPSB7fQogICAgbWVtX2lkcyA9IHt9CiAgICBjb3VudCA9IHt9CiAgICBmb3IgcGlkIGluIG9zLmxpc3RkaXIocHJvYy5wYXRoKCcnKSk6CiAgICAgICAgaWYgbm90IHBpZC5pc2RpZ2l0KCk6CiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgcGlkID0gaW50KHBpZCkKCiAgICAgICAgIyBTb21lIGZpbHRlcnMKICAgICAgICBpZiBvbmx5X3NlbGYgYW5kIHBpZCAhPSBvdXJfcGlkOgogICAgICAgICAgICBjb250aW51ZQogICAgICAgIGlmIHBpZCA9PSBvdXJfcGlkIGFuZCBub3QgaW5jbHVkZV9zZWxmOgogICAgICAgICAgICBjb250aW51ZQogICAgICAgIGlmIHBpZHNfdG9fc2hvdyBpcyBub3QgTm9uZSBhbmQgcGlkIG5vdCBpbiBwaWRzX3RvX3Nob3c6CiAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgIHRyeToKICAgICAgICAgICAgY21kID0gZ2V0Q21kTmFtZShwaWQsIHNwbGl0X2FyZ3MpCiAgICAgICAgZXhjZXB0IExvb2t1cEVycm9yOgogICAgICAgICAgICAjb3BlcmF0aW9uIG5vdCBwZXJtaXR0ZWQKICAgICAgICAgICAgI2tlcm5lbCB0aHJlYWRzIGRvbid0IGhhdmUgZXhlIGxpbmtzIG9yCiAgICAgICAgICAgICNwcm9jZXNzIGdvbmUKICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBwcml2YXRlLCBzaGFyZWQsIG1lbV9pZCA9IGdldE1lbVN0YXRzKHBpZCkKICAgICAgICBleGNlcHQgUnVudGltZUVycm9yOgogICAgICAgICAgICBjb250aW51ZSAjcHJvY2VzcyBnb25lCiAgICAgICAgaWYgc2hhcmVkcy5nZXQoY21kKToKICAgICAgICAgICAgaWYgaGF2ZV9wc3M6ICNhZGQgc2hhcmVkIHBvcnRpb24gb2YgUFNTIHRvZ2V0aGVyCiAgICAgICAgICAgICAgICBzaGFyZWRzW2NtZF0gKz0gc2hhcmVkCiAgICAgICAgICAgIGVsaWYgc2hhcmVkc1tjbWRdIDwgc2hhcmVkOiAjanVzdCB0YWtlIGxhcmdlc3Qgc2hhcmVkIHZhbAogICAgICAgICAgICAgICAgc2hhcmVkc1tjbWRdID0gc2hhcmVkCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2hhcmVkc1tjbWRdID0gc2hhcmVkCiAgICAgICAgY21kc1tjbWRdID0gY21kcy5zZXRkZWZhdWx0KGNtZCwgMCkgKyBwcml2YXRlCiAgICAgICAgaWYgY21kIGluIGNvdW50OgogICAgICAgICAgICBjb3VudFtjbWRdICs9IDEKICAgICAgICBlbHNlOgogICAgICAgICAgICBjb3VudFtjbWRdID0gMQogICAgICAgIG1lbV9pZHMuc2V0ZGVmYXVsdChjbWQsIHt9KS51cGRhdGUoe21lbV9pZDpOb25lfSkKCiAgICAjQWRkIHNoYXJlZCBtZW0gZm9yIGVhY2ggcHJvZ3JhbQogICAgdG90YWwgPSAwCiAgICBmb3IgY21kIGluIGNtZHM6CiAgICAgICAgY21kX2NvdW50ID0gY291bnRbY21kXQogICAgICAgIGlmIGxlbihtZW1faWRzW2NtZF0pID09IDEgYW5kIGNtZF9jb3VudCA+IDE6CiAgICAgICAgICAgICMgQXNzdW1lIHRoaXMgcHJvZ3JhbSBpcyB1c2luZyBDTE9ORV9WTSB3aXRob3V0IENMT05FX1RIUkVBRAogICAgICAgICAgICAjIHNvIG9ubHkgYWNjb3VudCBmb3Igb25lIG9mIHRoZSBwcm9jZXNzZXMKICAgICAgICAgICAgY21kc1tjbWRdIC89IGNtZF9jb3VudAogICAgICAgICAgICBpZiBoYXZlX3BzczoKICAgICAgICAgICAgICAgIHNoYXJlZHNbY21kXSAvPSBjbWRfY291bnQKICAgICAgICBjbWRzW2NtZF0gPSBjbWRzW2NtZF0gKyBzaGFyZWRzW2NtZF0KICAgICAgICB0b3RhbCArPSBjbWRzW2NtZF0gI3ZhbGlkIGlmIFBTUyBhdmFpbGFibGUKCiAgICBzb3J0ZWRfY21kcyA9IHNvcnRlZChjbWRzLml0ZW1zKCksIGtleT1sYW1iZGEgeDp4WzFdKQogICAgc29ydGVkX2NtZHMgPSBbeCBmb3IgeCBpbiBzb3J0ZWRfY21kcyBpZiB4WzFdXQoKICAgIHJldHVybiBzb3J0ZWRfY21kcywgc2hhcmVkcywgY291bnQsIHRvdGFsCgpkZWYgcHJpbnRfaGVhZGVyKCk6CiAgICBzeXMuc3Rkb3V0LndyaXRlKCIgUHJpdmF0ZSAgKyAgIFNoYXJlZCAgPSAgUkFNIHVzZWRcdFByb2dyYW1cblxuIikKCmRlZiBwcmludF9tZW1vcnlfdXNhZ2Uoc29ydGVkX2NtZHMsIHNoYXJlZHMsIGNvdW50LCB0b3RhbCk6CiAgICBmb3IgY21kIGluIHNvcnRlZF9jbWRzOgogICAgICAgIHN5cy5zdGRvdXQud3JpdGUoIiU5cyArICU5cyA9ICU5c1x0JXNcbiIgJQogICAgICAgICAgICAgICAgICAgICAgICAgKGh1bWFuKGNtZFsxXS1zaGFyZWRzW2NtZFswXV0pLAogICAgICAgICAgICAgICAgICAgICAgICAgIGh1bWFuKHNoYXJlZHNbY21kWzBdXSksIGh1bWFuKGNtZFsxXSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgY21kX3dpdGhfY291bnQoY21kWzBdLCBjb3VudFtjbWRbMF1dKSkpCiAgICBpZiBoYXZlX3BzczoKICAgICAgICBzeXMuc3Rkb3V0LndyaXRlKCIlc1xuJXMlOXNcbiVzXG4iICUKICAgICAgICAgICAgICAgICAgICAgICAgICgiLSIgKiAzMywgIiAiICogMjQsIGh1bWFuKHRvdGFsKSwgIj0iICogMzMpKQoKZGVmIHZlcmlmeV9lbnZpcm9ubWVudCgpOgogICAgaWYgb3MuZ2V0ZXVpZCgpICE9IDA6CiAgICAgICAgc3lzLnN0ZGVyci53cml0ZSgiU29ycnksIHJvb3QgcGVybWlzc2lvbiByZXF1aXJlZC5cbiIpCiAgICAgICAgaWYgX19uYW1lX18gPT0gJ19fbWFpbl9fJzoKICAgICAgICAgICAgc3lzLnN0ZGVyci5jbG9zZSgpCiAgICAgICAgICAgIHN5cy5leGl0KDEpCgogICAgdHJ5OgogICAgICAgIGt2ID0ga2VybmVsX3ZlcigpCiAgICBleGNlcHQgKElPRXJyb3IsIE9TRXJyb3IpOgogICAgICAgIHZhbCA9IHN5cy5leGNfaW5mbygpWzFdCiAgICAgICAgaWYgdmFsLmVycm5vID09IGVycm5vLkVOT0VOVDoKICAgICAgICAgICAgc3lzLnN0ZGVyci53cml0ZSgKICAgICAgICAgICAgICAiQ291bGRuJ3QgYWNjZXNzICIgKyBwcm9jLnBhdGgoJycpICsgIlxuIgogICAgICAgICAgICAgICJPbmx5IEdOVS9MaW51eCBhbmQgRnJlZUJTRCAod2l0aCBsaW5wcm9jZnMpIGFyZSBzdXBwb3J0ZWRcbiIpCiAgICAgICAgICAgIHN5cy5leGl0KDIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmFpc2UKCmlmIF9fbmFtZV9fID09ICdfX21haW5fXyc6CiAgICBzcGxpdF9hcmdzLCBwaWRzX3RvX3Nob3csIHdhdGNoLCBvbmx5X3RvdGFsID0gcGFyc2Vfb3B0aW9ucygpCiAgICB2ZXJpZnlfZW52aXJvbm1lbnQoKQoKICAgIGlmIG5vdCBvbmx5X3RvdGFsOgogICAgICAgIHByaW50X2hlYWRlcigpCgogICAgaWYgd2F0Y2ggaXMgbm90IE5vbmU6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzb3J0ZWRfY21kcyA9IFRydWUKICAgICAgICAgICAgd2hpbGUgc29ydGVkX2NtZHM6CiAgICAgICAgICAgICAgICBzb3J0ZWRfY21kcywgc2hhcmVkcywgY291bnQsIHRvdGFsID0gZ2V0X21lbW9yeV91c2FnZSggcGlkc190b19zaG93LCBzcGxpdF9hcmdzICkKICAgICAgICAgICAgICAgIGlmIG9ubHlfdG90YWwgYW5kIGhhdmVfcHNzOgogICAgICAgICAgICAgICAgICAgIHN5cy5zdGRvdXQud3JpdGUoaHVtYW4odG90YWwsIHVuaXRzPTEpKydcbicpCiAgICAgICAgICAgICAgICBlbGlmIG5vdCBvbmx5X3RvdGFsOgogICAgICAgICAgICAgICAgICAgIHByaW50X21lbW9yeV91c2FnZShzb3J0ZWRfY21kcywgc2hhcmVkcywgY291bnQsIHRvdGFsKQogICAgICAgICAgICAgICAgdGltZS5zbGVlcCh3YXRjaCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHN5cy5zdGRvdXQud3JpdGUoJ1Byb2Nlc3MgZG9lcyBub3QgZXhpc3QgYW55bW9yZS5cbicpCiAgICAgICAgZXhjZXB0IEtleWJvYXJkSW50ZXJydXB0OgogICAgICAgICAgICBwYXNzCiAgICBlbHNlOgogICAgICAgICMgVGhpcyBpcyB0aGUgZGVmYXVsdCBiZWhhdmlvcgogICAgICAgIHNvcnRlZF9jbWRzLCBzaGFyZWRzLCBjb3VudCwgdG90YWwgPSBnZXRfbWVtb3J5X3VzYWdlKCBwaWRzX3RvX3Nob3csIHNwbGl0X2FyZ3MgKQogICAgICAgIGlmIG9ubHlfdG90YWwgYW5kIGhhdmVfcHNzOgogICAgICAgICAgICBzeXMuc3Rkb3V0LndyaXRlKGh1bWFuKHRvdGFsLCB1bml0cz0xKSsnXG4nKQogICAgICAgIGVsaWYgbm90IG9ubHlfdG90YWw6CiAgICAgICAgICAgIHByaW50X21lbW9yeV91c2FnZShzb3J0ZWRfY21kcywgc2hhcmVkcywgY291bnQsIHRvdGFsKQoKICAgICMgV2UgbXVzdCBjbG9zZSBleHBsaWNpdGx5LCBzbyB0aGF0IGFueSBFUElQRSBleGNlcHRpb24KICAgICMgaXMgaGFuZGxlZCBieSBvdXIgZXhjZXB0aG9vaywgcmF0aGVyIHRoYW4gdGhlIGRlZmF1bHQKICAgICMgb25lIHdoaWNoIGlzIHJlZW5hYmxlZCBhZnRlciB0aGlzIHNjcmlwdCBmaW5pc2hlcy4KICAgIHN5cy5zdGRvdXQuY2xvc2UoKQoKICAgIHZtX2FjY3VyYWN5ID0gc2hhcmVkX3ZhbF9hY2N1cmFjeSgpCiAgICBzaG93X3NoYXJlZF92YWxfYWNjdXJhY3koIHZtX2FjY3VyYWN5LCBvbmx5X3RvdGFsICkK' | base64 --decode | sudo tee /usr/local/bin/ps_mem.py &amp;&amp; sudo chmod +x /usr/local/bin/ps_mem.py</description>
            <groups>
                <group>
                    <name>Templates/Applications</name>
                </group>
            </groups>
            <applications>
                <application>
                    <name>Processes of Zabbix</name>
                </application>
                <application>
                    <name>Zabbix raw items</name>
                </application>
            </applications>
            <items>
                <item>
                    <name>List processes</name>
                    <type>ZABBIX_ACTIVE</type>
                    <key>system.run[&quot;{$ZABBIX.PROCESSES}&quot;]</key>
                    <delay>13m</delay>
                    <trends>0</trends>
                    <value_type>TEXT</value_type>
                    <applications>
                        <application>
                            <name>Zabbix raw items</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                            <params>1d</params>
                        </step>
                    </preprocessing>
                </item>
            </items>
            <discovery_rules>
                <discovery_rule>
                    <name>Processes of Zabbix</name>
                    <type>DEPENDENT</type>
                    <key>processes.of.zabbix</key>
                    <delay>0</delay>
                    <item_prototypes>
                        <item_prototype>
                            <name>{#COMPONENT} {#PROCESS}</name>
                            <type>ZABBIX_ACTIVE</type>
                            <key>system.run[&quot;{$PS.MEM.START}{#PROCESS}{$PS.MEM.END}&quot;]</key>
                            <delay>5m</delay>
                            <units>B</units>
                            <applications>
                                <application>
                                    <name>Processes of Zabbix</name>
                                </application>
                            </applications>
                            <application_prototypes>
                                <application_prototype>
                                    <name>{#COMPONENT}</name>
                                </application_prototype>
                            </application_prototypes>
                        </item_prototype>
                    </item_prototypes>
                    <graph_prototypes>
                        <graph_prototype>
                            <name>Memory {#COMPONENT} {#PROCESS}</name>
                            <ymin_type_1>FIXED</ymin_type_1>
                            <graph_items>
                                <graph_item>
                                    <sortorder>1</sortorder>
                                    <color>1A7C11</color>
                                    <item>
                                        <host>Zabbix processes memory usage</host>
                                        <key>system.run[&quot;{$PS.MEM.START}{#PROCESS}{$PS.MEM.END}&quot;]</key>
                                    </item>
                                </graph_item>
                            </graph_items>
                        </graph_prototype>
                    </graph_prototypes>
                    <master_item>
                        <key>system.run[&quot;{$ZABBIX.PROCESSES}&quot;]</key>
                    </master_item>
                    <preprocessing>
                        <step>
                            <type>JAVASCRIPT</type>
                            <params>var lld = [];
var lines = value.split(&quot;\n&quot;);
var lines_num = lines.length;
for (i = 0; i &lt; lines_num; i++)
{
  var row = {};
  row[&quot;{#COMPONENT}&quot;] = lines[i].replace(/: .*$/,'');
  row[&quot;{#PROCESS}&quot;] = lines[i].replace(/^.*: /,'');;
  lld.push(row);
}
return JSON.stringify(lld);</params>
                        </step>
                    </preprocessing>
                </discovery_rule>
            </discovery_rules>
            <macros>
                <macro>
                    <macro>{$PS.MEM.END}</macro>
                    <value>&quot;)</value>
                    <description>so we do not need to escape special characters</description>
                </macro>
                <macro>
                    <macro>{$PS.MEM.START}</macro>
                    <value>ps_mem.py --total -p $(pgrep -d, -f &quot;[ ]</value>
                    <description>so we do not need to escape special characters</description>
                </macro>
                <macro>
                    <macro>{$ZABBIX.PROCESSES}</macro>
                    <value>pgrep -a 'zabbix_(server|agentd|agent2|proxy)' | egrep -o --color=none 'zabbix_(server|agentd|agent2|proxy): .*' | sed 's/ [#\[].*//' | sort -u</value>
                    <description>One-liner to list unique processes per component</description>
                </macro>
            </macros>
        </template>
    </templates>
</zabbix_export>
